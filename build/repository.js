// Generated by CoffeeScript 1.10.0
(function() {
  var Event;

  Event = require('./event');

  module.exports = function(aggregateName, Aggregate, eventStore) {
    var _delete, add, cache, load, properties;
    aggregateName = aggregateName.trim();
    cache = {};
    add = function(attrs) {
      var agg, state;
      agg = Aggregate(Object.assign({}, attrs));
      cache[agg.id] = agg;
      state = Object.assign({}, agg.state);
      return Event({
        name: aggregateName + "CreatedEvent",
        aggregateId: agg.id,
        state: state,
        payload: attrs
      });
    };
    load = function(aggregateId) {
      var toReturn;
      if (cache[aggregateId]) {
        return cache[aggregateId];
      } else {
        toReturn = null;
        eventStore.getEvents().reverse().some(function(event) {
          var agg;
          if (event.aggregateId === aggregateId) {
            if (event.name === (aggregateName + "DeletedEvent")) {
              toReturn = null;
            } else {
              agg = Aggregate(Object.assign({
                id: aggregateId
              }, event.state));
              cache[aggregateId] = agg;
              toReturn = agg;
            }
            return true;
          }
        });
        return toReturn;
      }
    };
    _delete = function(aggregateId) {
      var event, state;
      state = load(aggregateId).state;
      event = Event({
        name: aggregateName + "DeletedEvent",
        aggregateId: aggregateId,
        state: state
      });
      delete cache[aggregateId];
      return event;
    };
    properties = {
      add: {
        value: add
      },
      load: {
        value: load
      },
      "delete": {
        value: _delete
      }
    };
    return Object.defineProperties({}, properties);
  };

}).call(this);

// Generated by CoffeeScript 1.10.0
(function() {
  var Event, assign;

  Event = require('./event');

  assign = require('./deepAssign');

  module.exports = function(Aggregate, eventStore, aggregateName) {
    var _load, add, cache, load, properties, remove;
    if (aggregateName == null) {
      aggregateName = void 0;
    }
    if (aggregateName == null) {
      aggregateName = Aggregate.__aggregate_name__;
    }
    cache = {};
    _load = function(aggregateId, events) {
      var agg, createdEvent, relevantEvents;
      relevantEvents = events.filter(function(event) {
        return event.aggregateId === aggregateId;
      });
      if (relevantEvents.length === 0 || relevantEvents.find(function(arg) {
        var name;
        name = arg.name;
        return name === (aggregateName + "DeletedEvent");
      })) {
        return null;
      } else {
        createdEvent = relevantEvents.splice(0, 1)[0];
        agg = Aggregate(assign({
          id: aggregateId
        }, createdEvent.payload));
        relevantEvents.forEach(function(event) {
          return Aggregate.__sourcing_methods__[event.name](event.payload, agg);
        });
        cache[aggregateId] = agg;
        return agg;
      }
    };
    add = function(attrs) {
      var agg, state;
      agg = Aggregate(assign({}, attrs));
      cache[agg.id] = agg;
      state = assign({}, agg.state);
      return Event({
        name: aggregateName + "CreatedEvent",
        aggregateId: agg.id,
        state: state,
        payload: attrs
      });
    };
    load = function(aggregateId) {
      var agg;
      if (agg = cache[aggregateId]) {
        return Promise.resolve(agg);
      } else {
        return new Promise(function(resolve, reject) {
          return Promise.resolve(eventStore.getEvents()).then(function(events) {
            var aggregate;
            if (aggregate = _load(aggregateId, events)) {
              return resolve(aggregate);
            } else {
              return reject();
            }
          });
        });
      }
    };
    remove = function(aggregateId) {
      return load(aggregateId).then(function(agg) {
        if (agg.state == null) {
          Promise.reject("Could not load aggregate with id of " + aggregateId);
        }
        delete cache[aggregateId];
        return Promise.resolve(Event({
          name: aggregateName + "DeletedEvent",
          aggregateId: aggregateId,
          state: agg.state,
          payload: {}
        }));
      });
    };
    properties = {
      add: {
        value: add
      },
      load: {
        value: load
      },
      "delete": {
        value: remove
      }
    };
    return Object.defineProperties({}, properties);
  };

}).call(this);
